# ============================================
# Configurazione QoS per OpenWrt
# File: /etc/qos.conf
# ============================================
#
# Questo file contiene tutte le variabili di configurazione
# per il sistema di Qualità del Servizio basato su HFSC
#
# Modificare i valori secondo le proprie necessità
# Dopo le modifiche, eseguire: /etc/init.d/qos reload
#

# ============================================
# CONFIGURAZIONE INTERFACCE
# ============================================

# Interfaccia WAN (verso Internet)
# Lasciare vuoto per rilevamento automatico
IFACE_WAN="eth1"

# Interfaccia LAN (rete locale)
# Lasciare vuoto per rilevamento automatico  
IFACE_LAN="eth0"

# ============================================
# CONFIGURAZIONE BANDA
# ============================================

# Banda totale disponibile in kilobit al secondo (kbit/s)
# IMPORTANTE: Impostare al 90-95% della banda reale per evitare bufferbloat
# Esempio: se hai 10 Mbit/s reali, imposta 9000 kbit/s

# Upload (dal router verso Internet)
BANDA_UPLOAD=1000

# Download (da Internet verso il router) - per future implementazioni
BANDA_DOWNLOAD=10000

# ============================================
# CONFIGURAZIONE UTENTI/RETI
# ============================================

# Definizione delle reti o IP con diverse priorità
# Formato: IP singolo (192.168.1.100/32) o sottorete (192.168.1.0/24)
# Per IP multipli, separa con virgole: "192.168.1.10/32,192.168.1.20/32"

# Rete/IP ad ALTA priorità (50% banda garantita)
RETE_PRIORITA_ALTA="192.168.99.3/32"

# Rete/IP a MEDIA priorità (25% banda garantita)
RETE_PRIORITA_MEDIA="192.168.99.4/32"

# Rete/IP a BASSA priorità (12% banda garantita)
RETE_PRIORITA_BASSA="192.168.99.5/32"

# ============================================
# ALLOCAZIONE PERCENTUALE BANDA
# ============================================

# Percentuali di banda GARANTITA per ogni classe
# La somma dovrebbe essere <= 100

PCT_ALTA=50      # Percentuale per utenti alta priorità
PCT_MEDIA=25     # Percentuale per utenti media priorità
PCT_BASSA=12     # Percentuale per utenti bassa priorità
PCT_DEFAULT=13   # Percentuale per traffico non classificato

# ============================================
# CONFIGURAZIONE SERVIZI CRITICI
# ============================================

# Banda riservata per traffico interattivo (SSH, DNS, ping)
# Valore in kbit/s o lasciare vuoto per calcolo automatico (10% del totale)
BANDA_INTERATTIVO=""

# Latenza massima tollerata per traffico interattivo (millisecondi)
LATENZA_INTERATTIVO=5

# Banda riservata per VoIP/Videoconferenze
# Valore in kbit/s o lasciare vuoto per calcolo automatico (20% del totale)
BANDA_VOIP=""

# Latenza massima tollerata per VoIP (millisecondi)
LATENZA_VOIP=10

# ============================================
# CONFIGURAZIONE SERVIZI SPECIFICI
# ============================================

# Porte per servizi VoIP personalizzati
# Formato: "inizio:fine" separate da spazi
VOIP_PORTS_UDP="5060:5061 10000:20000 3478:3481"
VOIP_PORTS_TCP=""

# Porte per servizi interattivi personalizzati
INTERACTIVE_PORTS_TCP="22 23 3389"
INTERACTIVE_PORTS_UDP="53 123"

# ============================================
# OTTIMIZZAZIONI AVANZATE
# ============================================

# RTT (Round Trip Time) tipico in millisecondi
# Usato per calcolare buffer ottimali
RTT_TYPICAL=50

# Fattore di overbooking (1.0 = no overbooking, 1.5 = 50% overbooking)
# Permette di allocare più del 100% assumendo che non tutti usino 
# contemporaneamente tutta la banda
OVERBOOKING_FACTOR=1.0

# Abilita ottimizzazioni per connessioni lente (<= 2Mbit)
SLOW_LINK_OPTIMIZATIONS=0

# ============================================
# LOGGING E DEBUG
# ============================================

# Livello di log (0=disabilitato, 1=normale, 2=verboso)
VERBOSE=1

# Debug mode (0=disabilitato, 1=abilitato)
DEBUG=1

# File di log
LOG_FILE="/var/log/qos.log"

# Dimensione massima log in KB (0=illimitato)
LOG_MAX_SIZE=1024

# ============================================
# GESTIONE SERVIZIO
# ============================================

# Avvio automatico del monitoraggio dopo start (0=no, 1=si)
AUTO_MONITOR=1

# Intervallo monitoraggio in secondi
MONITOR_INTERVAL=5

# Salvataggio automatico statistiche (0=no, 1=si)
AUTO_SAVE_STATS=0

# Intervallo salvataggio statistiche (minuti)
STATS_SAVE_INTERVAL=60

# ============================================
# PROFILI PREDEFINITI
# ============================================

# Profilo da utilizzare (default, gaming, streaming, office, custom)
# Ogni profilo pre-configura le percentuali in modo ottimale
QOS_PROFILE="custom"

# Configurazioni per profili predefiniti
# Non modificare a meno che non si sappia cosa si sta facendo

case "$QOS_PROFILE" in
    "gaming")
        # Ottimizzato per gaming online - bassa latenza
        PCT_ALTA=60
        PCT_MEDIA=20
        PCT_BASSA=10
        PCT_DEFAULT=10
        LATENZA_INTERATTIVO=3
        LATENZA_VOIP=5
        ;;
        
    "streaming")
        # Ottimizzato per streaming video
        PCT_ALTA=40
        PCT_MEDIA=35
        PCT_BASSA=15
        PCT_DEFAULT=10
        BANDA_VOIP=$((BANDA_UPLOAD * 30 / 100))
        ;;
        
    "office")
        # Bilanciato per uso ufficio
        PCT_ALTA=40
        PCT_MEDIA=30
        PCT_BASSA=20
        PCT_DEFAULT=10
        ;;
        
    "voip")
        # Priorità massima a VoIP/videoconferenze
        PCT_ALTA=30
        PCT_MEDIA=25
        PCT_BASSA=20
        PCT_DEFAULT=25
        BANDA_VOIP=$((BANDA_UPLOAD * 40 / 100))
        LATENZA_VOIP=5
        ;;
        
    "custom"|*)
        # Usa i valori definiti sopra
        ;;
esac

# ============================================
# VALIDAZIONE CONFIGURAZIONE
# ============================================

# Non modificare questa sezione
# Calcola valori derivati e verifica coerenza

# Calcola banda servizi se non specificata
[ -z "$BANDA_INTERATTIVO" ] && BANDA_INTERATTIVO=$((BANDA_UPLOAD / 10))
[ -z "$BANDA_VOIP" ] && BANDA_VOIP=$((BANDA_UPLOAD / 5))

# Verifica che la somma delle percentuali non superi 100
TOTAL_PCT=$((PCT_ALTA + PCT_MEDIA + PCT_BASSA + PCT_DEFAULT))
if [ $TOTAL_PCT -gt 100 ]; then
    echo "AVVISO: La somma delle percentuali ($TOTAL_PCT%) supera 100%"
    echo "         Il sistema applicherà overbooking"
fi

# Verifica banda minima
if [ $BANDA_UPLOAD -lt 256 ]; then
    echo "AVVISO: Banda upload molto bassa (<256 kbit/s)"
    echo "         Abilitazione ottimizzazioni per link lenti"
    SLOW_LINK_OPTIMIZATIONS=1
fi

# Fine configurazione
