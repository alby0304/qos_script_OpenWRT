#!/bin/sh /etc/rc.common
# Script di init per QoS su OpenWrt
# File: /etc/init.d/qos
# 
# Abilitare con: /etc/init.d/qos enable
# Avviare con:  /etc/init.d/qos start

START=50
STOP=50

USE_PROCD=1
PROG=/usr/sbin/qos.sh
CONFIG_FILE=/etc/qos.conf
PID_FILE=/var/run/qos.pid

# Carica configurazione dal file .conf
[ -f "$CONFIG_FILE" ] && . "$CONFIG_FILE"

start_service() {
    # Verifica prerequisiti
    [ -x "$PROG" ] || {
        echo "[ERRORE] Script QoS non trovato o non eseguibile: $PROG"
        return 1
    }
    
    [ -f "$CONFIG_FILE" ] || {
        echo "[ERRORE] File di configurazione non trovato: $CONFIG_FILE"
        return 1
    }
    
    echo "[INFO] Avvio servizio QoS..."
    
    # Avvia usando procd per gestione servizio
    procd_open_instance
    procd_set_param command $PROG start
    procd_set_param file $CONFIG_FILE
    procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile $PID_FILE
    procd_close_instance
}

stop_service() {
    echo "[INFO] Arresto servizio QoS..."
    $PROG stop
}

reload_service() {
    echo "[INFO] Ricaricamento configurazione QoS..."
    # Ricarica il file di configurazione
    [ -f "$CONFIG_FILE" ] && . "$CONFIG_FILE"
    $PROG reload
}

service_triggers() {
    # Ricarica quando cambia il file di configurazione
    procd_add_reload_trigger "qos"
    
    # Ricarica quando l'interfaccia WAN si riconnette
    procd_add_interface_trigger "interface.*.up" "wan" /etc/init.d/qos reload
}

status() {
    $PROG status
}

monitor() {
    $PROG monitor "${1:-2}"
}

boot() {
    # Aspetta che la rete sia pronta prima di avviare QoS
    sleep 10
    start
}